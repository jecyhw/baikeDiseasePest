//
// Copyright ï¿½ 2011 LobsterPot Solutions - www.lobsterpot.com.au
// enquiries@lobsterpot.com.au
// 
//PivotViewer
var PivotViewer=PivotViewer||{};PivotViewer.Models={},PivotViewer.Models.Loaders={},PivotViewer.Utils={},PivotViewer.Views={};var Debug=Debug||{};(function(a){var b={};a.publish=function(c,e){b[c]&&a.each(b[c],function(){this.apply(a,e||[])})},a.subscribe=function(a,c){return b[a]||(b[a]=[]),b[a].push(c),[a,c]},a.unsubscribe=function(c){var e=c[0];b[e]&&a.each(b[e],function(a){this==c[1]&&b[e].splice(a,1)})}})(jQuery),Debug.Log=function(a){window.console&&window.console.log&&typeof debug!="undefined"&&debug==1&&window.console.log(a)},window.requestAnimFrame=function(a){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),PivotViewer.Utils.EscapeMetaChars=function(a){return a.replace(/\|/gi,"\\|").replace(/\//gi,"\\/").replace(/'/gi,"\\'").replace(/,/gi,"\\,").replace(/:/gi,"\\:").replace(/\(/gi,"\\(").replace(/\)/gi,"\\)").replace(/\+/gi,"\\+").replace(/\+/gi,"\\-").replace(/\+/gi,"\\_").replace(/\+/gi,"\\%")},PivotViewer.Utils.EscapeItemId=function(a){return a.replace(/\s+/gi,"|").replace(/'/gi,"").replace(/\(/gi,"").replace(/\)/gi,"").replace(/\./gi,"")},PivotViewer.Utils.Now=function(){return Date.now?Date.now():(new Date).getTime()},PivotViewer.Utils.Min=function(a){var b=1e6;for(var c=0,d=a.length;c<d;c++)b=b>a[c]?a[c]:b;return b},PivotViewer.Utils.Max=function(a){var b=-1e6;for(var c=0,d=a.length;c<d;c++)b=b<a[c]?a[c]:b;return b},PivotViewer.Utils.Histogram=function(a){if(!a instanceof Array)return null;var b=PivotViewer.Utils.Min(a),c=PivotViewer.Utils.Max(a),d=(Math.floor(Math.pow(2*a.length,1/3))+1)*2;d>10&&(d=10);var e=(c+1-(b-1))/d,f=[];for(var g=0;g<d;g++){var h=b+g*e,i=b+(g+1)*e;f.push([]);for(var j=0,k=a.length;j<k;j++)h<=a[j]&&i>a[j]&&f[g].push(a[j])}return{Histogram:f,Min:b,Max:c,BinCount:d}},function(){var a=!1,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;Object.subClass=function(c){function g(){!a&&this.init&&this.init.apply(this,arguments)}var d=this.prototype;a=!0;var e=new this;a=!1;for(var f in c)e[f]=typeof c[f]=="function"&&typeof d[f]=="function"&&b.test(c[f])?function(a,b){return function(){var c=this._super;this._super=d[a];var e=b.apply(this,arguments);return this._super=c,e}}(f,c[f]):c[f];return g.prototype=e,g.constructor=g,g.subClass=arguments.callee,g}}(),PivotViewer.Models.Collection=Object.subClass({init:function(){var a="http://schemas.microsoft.com/collection/metadata/2009",b="http://schemas.microsoft.com/livelabs/pivot/collection/2009";this.CollectionName="",this.BrandImage="",this.FacetCategories=[],this.Items=[],this.CXMLBase="",this.ImageBase=""},GetItemById:function(a){for(var b=0;b<this.Items.length;b++)if(this.Items[b].Id==a)return this.Items[b];return null},GetFacetCategoryByName:function(a){for(var b=0;b<this.FacetCategories.length;b++)if(this.FacetCategories[b].Name==a)return this.FacetCategories[b];return null}}),PivotViewer.Models.FacetCategory=Object.subClass({init:function(a,b,c,d,e,f,g){this.Name=a,this.Format=b,this.Type=c!=null&&c!=undefined?c:PivotViewer.Models.FacetType.String,this.IsFilterVisible=d!=null&&d!=undefined?d:!0,this.IsMetaDataVisible=e!=null&&e!=undefined?e:!0,this.IsWordWheelVisible=f!=null&&f!=undefined?f:!0,this.CustomSort}}),PivotViewer.Models.FacetCategorySort=Object.subClass({init:function(a){this.Name=a,this.SortValues=[]}}),PivotViewer.Models.Item=Object.subClass({init:function(a,b,c,d){this.Img=parseInt(a),this.Id=b,this.Href=c,this.Name=d,this.Description,this.Facets=[]}}),PivotViewer.Models.Facet=Object.subClass({init:function(a){this.Name=a,this.FacetValues=[]},AddFacetValue:function(a){this.FacetValues.push(a)}}),PivotViewer.Models.FacetValue=Object.subClass({init:function(a){this.Value=a,this.Href=""}}),PivotViewer.Models.FacetType={String:"String",LongString:"LongString",Number:"Number",DateTime:"DateTime",Link:"Link"},PivotViewer.Models.Loaders.ICollectionLoader=Object.subClass({init:function(){},LoadCollection:function(a){if(!a instanceof PivotViewer.Models.Collection)throw"collection not an instance of PivotViewer.Models.Collection."}}),PivotViewer.Models.Loaders.CXMLLoader=PivotViewer.Models.Loaders.ICollectionLoader.subClass({init:function(a){this.CXMLUri=a},LoadCollection:function(a){var a=a;this._super(a),a.CXMLBase=this.CXMLUri,$.ajax({type:"GET",url:this.CXMLUri,dataType:"xml",success:function(b){Debug.Log("CXML loaded");var c=$(b).find("Collection")[0],d="P";for(var e=0;e<c.attributes.length;e++)if(c.attributes[e].value=="http://schemas.microsoft.com/livelabs/pivot/collection/2009"){d=c.attributes[e].localName!=undefined?c.attributes[e].localName:c.attributes[e].baseName;break}a.CollectionName=$(c).attr("Name"),a.BrandImage=$(c).attr(d+":BrandImage")!=undefined?$(c).attr(d+":BrandImage"):"";var f=$(b).find("FacetCategory");for(var e=0;e<f.length;e++){var g=$(f[e]),h=new PivotViewer.Models.FacetCategory(g.attr("Name"),g.attr("Format"),g.attr("Type"),g.attr(d+":IsFilterVisible")!=undefined?g.attr(d+":IsFilterVisible").toLowerCase()=="true"?!0:!1:!0,g.attr(d+":IsMetaDataVisible")!=undefined?g.attr(d+":IsMetaDataVisible").toLowerCase()=="true"?!0:!1:!0,g.attr(d+":IsWordWheelVisible")!=undefined?g.attr(d+":IsWordWheelVisible").toLowerCase()=="true"?!0:!1:!1),i=g.find(d+"\\:SortOrder"),j=i.find(d+"\\:SortValue");i.length==0&&(i=g.find("SortOrder"),j=i.find("SortValue"));if(i.length==1){var k=new PivotViewer.Models.FacetCategorySort(i.attr("Name"));for(var l=0;l<j.length;l++)k.SortValues.push($(j[l]).attr("Value"));h.CustomSort=k}a.FacetCategories.push(h)}var m=$(b).find("Items");if(m.length==1){a.ImageBase=$(m[0]).attr("ImgBase");var n=$(m[0]).find("Item");for(var e=0;e<n.length;e++){var o=new PivotViewer.Models.Item($(n[e]).attr("Img").replace("#",""),$(n[e]).attr("Id"),$(n[e]).attr("Href"),$(n[e]).attr("Name")),p=$(n[e]).find("Description");p.length==1&&p[0].childNodes.length&&(o.Description=p[0].childNodes[0].nodeValue);var q=$(n[e]).find("Facet");for(var l=0;l<q.length;l++){var r=new PivotViewer.Models.Facet($(q[l]).attr("Name")),s=$(q[l]).children();for(var t=0;t<s.length;t++)if(s[t].nodeType==1){var u=$.trim($(s[t]).attr("Value"));if(u==null){var v=new PivotViewer.Models.FacetValue($(s[t]).attr("Name"));v.Href=$(s[t]).attr("Href"),r.AddFacetValue(v)}else if(s[t].nodeName=="Number"){var v=new PivotViewer.Models.FacetValue(parseFloat(u));r.AddFacetValue(v)}else{var v=new PivotViewer.Models.FacetValue(u);r.AddFacetValue(v)}}o.Facets.push(r)}a.Items.push(o)}}$.publish("/PivotViewer/Models/Collection/Loaded",null)},error:function(a,b,c){$(".pv-loading").remove();var d="";d+="Error loading CXML Collection\r\n\r\n",d=d+"URL        : "+this.url+"\r\n",d=d+"Statuscode : "+a.status+"\r\n",d=d+"Details    : "+c+"\r\n",d+="\r\nPivot Viewer cannot continue until this problem is resolved\r\r",window.alert(d)}})}}),PivotViewer.Views.IPivotViewerView=Object.subClass({init:function(){this.isActive=!1,this.init=!0,this.selected="",this.tiles=[]},Setup:function(a,b,c,d,e){},Filter:function(a,b,c){},GetUI:function(){return""},GetButtonImage:function(){return""},GetButtonImageSelected:function(){return""},GetViewName:function(){return""},Activate:function(){this.isActive=!0},Deactivate:function(){this.isActive=!1}}),PivotViewer.Views.TileBasedView=PivotViewer.Views.IPivotViewerView.subClass({OffsetTiles:function(a,b){for(var c=0;c<this.tiles.length;c++){var d=$.inArray(this.tiles[c].facetItem.Id,this.currentFilter);d>=0&&(this.tiles[c].destinationx+=a,this.tiles[c].destinationy+=b)}},SetInitialTiles:function(a,b,c){var d=b/2,e=c/2;for(var f=0;f<a.length;f++)a[f].x=d,a[f].y=e,a[f].velocityx=0,a[f].velocityy=0,a[f].startx=d,a[f].starty=e,a[f].destinationx=0,a[f].destinationy=0,a[f].width=1,a[f].height=1},GetRowsAndColumns:function(a,b,c,d){var e=.7,f=c*(d-Math.pow(e,2)),g=(b+a*c)*e,h=-1*b*a,i=(-1*g+Math.sqrt(Math.pow(g,2)-4*f*h))/(2*f),j=Math.floor(i*c),k=Math.ceil(b/j),l=Math.floor(a/i);return{Rows:k,Columns:l,TileWidth:i,TileHeight:j}},SetOuterTileDestination:function(a,b,c){var d=c.x-a/2,e=c.y-b/2,f=e/d,g=Math.atan2(e,d);c.destinationx=a*Math.cos(g)+a/2,c.destinationy=b*Math.sin(g)+b/2},SortBy:function(a,b,c){var d=function(b){if(c)for(var d=b.facetItem.Facets.length-1;d>-1;d-=1)if(b.facetItem.Facets[d].Name==a&&b.facetItem.Facets[d].FacetValues.length>0)return c(b.facetItem.Facets[d].FacetValues[0].Value);return null};return function(a,c){var e=d(a),f=d(c);return(e<f?-1:e>f?1:0)*[1,-1][+!!b]}}}),PivotViewer.Views.GridView=PivotViewer.Views.TileBasedView.subClass({init:function(){this.Scale=1,this._super();var a=this;$.subscribe("/PivotViewer/Views/Canvas/Click",function(b){if(!a.isActive)return;var c=null,d=0,e=0,f=0,g=0;for(var h=0;h<a.tiles.length;h++)a.tiles[h].Contains(b.x,b.y)?(c=a.tiles[h].facetItem.Id,d=Math.round((a.tiles[h].x-a.currentOffsetX)/a.tiles[h].width),e=Math.round((a.tiles[h].y-a.currentOffsetY)/a.tiles[h].height),a.tiles[h].Selected(!0),f=a.tiles[h].x,g=a.tiles[h].y):a.tiles[h].Selected(!1);if(c!=null&&a.selected!=c){a.selected=c,a.width<a.height?(a.currentWidth=a.width*a.rowscols.Columns*.9,a.currentHeight=a.height/a.width*a.currentWidth):(a.currentHeight=a.height*a.rowscols.Rows*.9,a.currentWidth=a.width/a.height*a.currentHeight);var i=a.GetRowsAndColumns(a.currentWidth-a.offsetX,a.currentHeight-a.offsetY,a.ratio,a.currentFilter.length);a.currentOffsetX=i.TileWidth*d*-1+a.width/2-i.TileWidth/2,a.currentOffsetY=i.TileHeight*e*-1+a.height/2-i.TileHeight/2,a.SetVisibleTilePositions(i,a.currentFilter,a.currentOffsetX,a.currentOffsetY,!0,!0,1e3)}else{a.selected=c=null,a.currentOffsetX=a.offsetX,a.currentOffsetY=a.offsetY,a.currentWidth=a.width,a.currentHeight=a.height;var i=a.GetRowsAndColumns(a.currentWidth-a.offsetX,a.currentHeight-a.offsetY,a.ratio,a.currentFilter.length);a.SetVisibleTilePositions(i,a.currentFilter,a.currentOffsetX,a.currentOffsetY,!0,!0,1e3)}$.publish("/PivotViewer/Views/Item/Selected",[c])}),$.subscribe("/PivotViewer/Views/Canvas/Hover",function(b){if(!a.isActive||a.selected.length>0)return;for(var c=0;c<a.tiles.length;c++)a.tiles[c].Contains(b.x,b.y)?a.tiles[c].Selected(!0):a.tiles[c].Selected(!1)}),$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(b){if(!a.isActive)return;var c=a.Scale,d=a.currentWidth,e=a.currentHeight,f=b.scale!=undefined?0:1e3;b.scale!=undefined?b.scale>=1?a.Scale+=b.scale-1:(a.Scale-=b.scale,a.Scale=a.Scale<1?1:a.Scale):b.delta!=undefined&&(a.Scale=b.delta>0?a.Scale/.7:a.Scale*.7),a.Scale==NaN&&(a.Scale=1);var g=(a.width-a.offsetX)*a.Scale,h=(a.height-a.offsetY)*a.Scale;if(g<a.width||a.Scale==1)a.currentOffsetX=a.offsetX,a.currentOffsetY=a.offsetY,a.currentWidth=a.width,a.currentHeight=a.height,a.Scale=1;else{var i=(b.x-a.currentOffsetX)/c*a.Scale,j=(b.y-a.currentOffsetY)/c*a.Scale;a.currentOffsetX=b.x-i,a.currentOffsetY=b.y-j,a.currentWidth=g,a.currentHeight=h}var k=a.GetRowsAndColumns(a.currentWidth-a.offsetX,a.currentHeight-a.offsetY,a.ratio,a.currentFilter.length);a.SetVisibleTilePositions(k,a.currentFilter,a.currentOffsetX,a.currentOffsetY,!0,!0,f);if(b.delta<0){for(var l=0;l<a.tiles.length;l++)a.tiles[l].Selected(!1);a.selected="",$.publish("/PivotViewer/Views/Item/Selected",[a.selected])}}),$.subscribe("/PivotViewer/Views/Canvas/Drag",function(b){if(!a.isActive)return;var c=b.x,d=b.y,e=!1,f=!1;a.currentOffsetX+=c,a.currentOffsetY+=d,c>0&&a.currentOffsetX>a.offsetX&&(a.currentOffsetX-=c,e=!0),d>0&&a.currentOffsetY>a.offsetY&&(a.currentOffsetY-=d,f=!0),a.currentOffsetX<a.offsetX&&a.currentWidth==a.width&&(a.currentOffsetX-=c,e=!0),c<0&&a.currentOffsetX<-1*(a.currentWidth-a.width)&&(a.currentOffsetX-=c,e=!0),a.currentOffsetY<a.offsetY&&a.currentHeight==a.height&&(a.currentOffsetY-=d,f=!0),d<0&&a.currentOffsetY-a.offsetY<-1*(a.currentHeight-a.height)&&(a.currentOffsetY-=d,f=!0);if(e&&f)return;e?a.OffsetTiles(0,d):f?a.OffsetTiles(c,0):a.OffsetTiles(c,d)})},Setup:function(a,b,c,d,e){this.width=a,this.height=b,this.offsetX=c,this.offsetY=d,this.ratio=e,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY},Filter:function(a,b,c){var d=this;if(!Modernizr.canvas)return;Debug.Log("Grid View Filtered: "+b.length),this.tiles=a,this.init&&this.SetInitialTiles(this.tiles,this.width,this.height),this.tiles=this.tiles.sort(this.SortBy(c,!1,function(a){return $.isNumeric(a)?a:a.toUpperCase()})),this.currentFilter=b;var e=0;Debug.Log("this.currentWidth: "+this.currentWidth+" this.width: "+this.width);if(this.currentWidth!=this.width&&!this.init){this.selected=selectedItem="",this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,this.currentWidth=this.width,this.currentHeight=this.height;var f=this.GetRowsAndColumns(this.currentWidth-this.offsetX,this.currentHeight-this.offsetY,this.ratio,this.tiles.length),g=[];for(var h=0;h<this.tiles.length;h++)g.push(this.tiles[h].facetItem.Id);this.SetVisibleTilePositions(f,g,this.currentOffsetX,this.currentOffsetY,!0,!1,1e3),e=1e3}setTimeout(function(){for(var a=0;a<d.tiles.length;a++){d.tiles[a].startx=d.tiles[a].x,d.tiles[a].starty=d.tiles[a].y,d.tiles[a].startwidth=d.tiles[a].width,d.tiles[a].startheight=d.tiles[a].height;var c=$.inArray(d.tiles[a].facetItem.Id,b);c<0&&(d.SetOuterTileDestination(d.width,d.height,d.tiles[a]),d.tiles[a].start=PivotViewer.Utils.Now(),d.tiles[a].end=d.tiles[a].start+1e3)}var e=b.length==d.tiles.length?0:500;setTimeout(function(){var a=d.GetRowsAndColumns(d.width-d.offsetX,d.height-d.offsetY,d.ratio,d.currentFilter.length);d.SetVisibleTilePositions(a,d.currentFilter,d.offsetX,d.offsetY,!1,!1,1e3)},e)},e),this.init=!1},GetUI:function(){return Modernizr.canvas?"":"<div class='pv-viewpanel-unabletodisplay'><h2>Unfortunately this view is unavailable as your browser does not support this functionality.</h2>Please try again with one of the following supported browsers: IE 9+, Chrome 4+, Firefox 2+, Safari 3.1+, iOS Safari 3.2+, Opera 9+<br/><a href='http://caniuse.com/#feat=canvas'>http://caniuse.com/#feat=canvas</a></div>"},GetButtonImage:function(){return"Content/images/GridView.png"},GetButtonImageSelected:function(){return"Content/images/GridViewSelected.png"},GetViewName:function(){return"Grid View"},SetVisibleTilePositions:function(a,b,c,d,e,f,g){var h=f?this.rowscols.Columns:a.Columns;f||(this.rowscols=a);var i=0,j=0;for(var k=0;k<this.tiles.length;k++){var l=$.inArray(this.tiles[k].facetItem.Id,b);l>=0&&(e&&(this.tiles[k].startx=this.tiles[k].x,this.tiles[k].starty=this.tiles[k].y,this.tiles[k].startwidth=this.tiles[k].width,this.tiles[k].startheight=this.tiles[k].height),this.tiles[k].destinationwidth=a.TileWidth,this.tiles[k].destinationheight=a.TileHeight,this.tiles[k].destinationx=i*a.TileWidth+c,this.tiles[k].destinationy=j*a.TileHeight+d,this.tiles[k].start=PivotViewer.Utils.Now(),this.tiles[k].end=this.tiles[k].start+g,i==h-1?(i=0,j++):i++)}}}),PivotViewer.Views.GraphView=PivotViewer.Views.TileBasedView.subClass({init:function(){this._super();var a=this;this.buckets=[],this.Scale=1,this.canvasHeightUIAdjusted=0,$.subscribe("/PivotViewer/Views/Canvas/Click",function(b){if(!a.isActive)return;var c=null,d=0,e=0,f=!1;for(var g=0;g<a.tiles.length;g++)a.tiles[g].Contains(b.x,b.y)?(c=a.tiles[g].facetItem.Id,d=a.tiles[g].x,e=a.tiles[g].y,a.tiles[g].Selected(!0),offsetX=a.tiles[g].x,offsetY=a.tiles[g].y,f=!0):a.tiles[g].Selected(!1);if(c!=null&&a.selected!=c){a.selected=c;if(a.width<a.height)var h=a.width*a.rowscols.Columns*.9,i=a.canvasHeightUIAdjusted/a.width*h;else var i=a.canvasHeightUIAdjusted*a.rowscols.Rows*.9,h=a.width/a.canvasHeightUIAdjusted*i;var j=i/a.canvasHeightUIAdjusted,k=h/(a.width-a.offsetX);a.columnWidth=h/a.buckets.length;var l=a.GetRowsAndColumns(a.columnWidth,i,a.ratio,a.bigCount);a.currentOffsetX=-((d-a.offsetX)*k)+a.width/2-l.TileWidth/2;var m=Math.ceil((a.canvasHeightUIAdjusted-e)/a.rowscols.TileHeight);a.currentOffsetY=31+l.TileHeight*(m-1),a.SetVisibleTileGraphPositions(l,a.currentOffsetX,a.currentOffsetY,!0,!0),$(".pv-viewarea-graphview-overlay div").fadeOut("slow")}else{a.selected=c=null,a.currentOffsetX=a.offsetX,a.currentOffsetY=a.offsetY,a.currentWidth=a.width,a.currentHeight=a.height-62,a.columnWidth=(a.width-a.offsetX)/a.buckets.length;var l=a.GetRowsAndColumns(a.columnWidth-2,a.currentHeight,a.ratio,a.bigCount);a.SetVisibleTileGraphPositions(l,a.offsetX,a.offsetY,!0,!0),$(".pv-viewarea-graphview-overlay div").fadeIn("slow")}$.publish("/PivotViewer/Views/Item/Selected",[c]);if(!f){var n=Math.floor((b.x-a.offsetX)/a.columnWidth);$.publish("/PivotViewer/Views/Item/Filtered",[{Facet:a.sortFacet,Item:a.buckets[n].startRange}])}}),$.subscribe("/PivotViewer/Views/Canvas/Hover",function(b){if(!a.isActive)return;$(".pv-viewarea-graphview-overlay-bucket").removeClass("graphview-bucket-hover");var c=Math.floor((b.x-a.offsetX)/a.columnWidth),d=$("#pv-viewarea-graphview-overlay-bucket-"+c);d.addClass("graphview-bucket-hover");for(var e=0;e<a.tiles.length;e++)a.tiles[e].Contains(b.x,b.y)?a.tiles[e].Selected(!0):a.tiles[e].Selected(!1)}),$.subscribe("/PivotViewer/Views/Canvas/Zoom",function(b){if(!a.isActive)return;var c=a.Scale,d=a.currentWidth,e=a.currentHeight,f=b.scale!=undefined?0:1e3;b.scale!=undefined?b.scale>=1?a.Scale+=b.scale-1:(a.Scale-=b.scale,a.Scale=a.Scale<1?1:a.Scale):b.delta!=undefined&&(a.Scale=b.delta>0?a.Scale/.7:a.Scale*.7),a.Scale==NaN&&(a.Scale=1);var g=(a.width-a.offsetX)*a.Scale,h=(a.height-a.offsetY-62)*a.Scale;g<a.width||a.Scale==1?(a.currentOffsetX=a.offsetX,a.currentOffsetY=a.offsetY,a.currentWidth=a.width-a.offsetX,a.currentHeight=a.height-a.offsetY-62,a.columnWidth=(a.width-a.offsetX)/a.buckets.length,a.Scale=1,$(".pv-viewarea-graphview-overlay div").fadeIn("slow")):(a.currentOffsetX=b.x-(b.x-a.currentOffsetX)/c*a.Scale,a.currentOffsetY=(a.canvasHeightUIAdjusted-b.y+a.offsetY)*a.Scale-(a.canvasHeightUIAdjusted+a.offsetY-b.y),a.currentWidth=g,a.currentHeight=h,a.columnWidth=g/a.buckets.length,$(".pv-viewarea-graphview-overlay div").fadeOut("slow"));var i=a.GetRowsAndColumns(a.columnWidth-2,a.currentHeight,a.ratio,a.bigCount);a.SetVisibleTileGraphPositions(i,a.currentOffsetX,a.currentOffsetY,!0,!0);if(b.delta<0){for(var j=0;j<a.tiles.length;j++)a.tiles[j].Selected(!1);a.selected=null,$.publish("/PivotViewer/Views/Item/Selected",[a.selected])}}),$.subscribe("/PivotViewer/Views/Canvas/Drag",function(b){if(!a.isActive)return;var c=b.x,d=b.y,e=!1,f=!1;a.currentOffsetX+=c,a.currentOffsetY+=d,c>0&&a.currentOffsetX>a.offsetX&&(a.currentOffsetX-=c,e=!0),d>0&&a.currentOffsetY+a.canvasHeightUIAdjusted>a.currentHeight+a.offsetY&&(a.currentOffsetY-=d,f=!0),a.currentOffsetX<a.offsetX&&a.currentWidth==a.width&&(a.currentOffsetX-=c,e=!0),c<0&&a.currentOffsetX<-1*(a.currentWidth-a.width)&&(a.currentOffsetX-=c,e=!0),a.currentOffsetY<a.offsetY&&a.currentHeight==a.height&&(a.currentOffsetY-=d,f=!0),d<0&&a.currentOffsetY-a.offsetY<-1*(a.currentHeight-a.height)&&(a.currentOffsetY-=d,f=!0);if(e&&f)return;e?a.OffsetTiles(0,d):f?a.OffsetTiles(c,0):a.OffsetTiles(c,d)})},Setup:function(a,b,c,d,e){this.width=a,this.height=b,this.offsetX=c,this.offsetY=d,this.ratio=e,this.currentWidth=this.width,this.currentHeight=this.height,this.currentOffsetX=this.offsetX,this.currentOffsetY=this.offsetY,this.rowscols=null,this.bigCount=0},Filter:function(a,b,c){var d=this;if(!Modernizr.canvas)return;Debug.Log("Graph View Filtered: "+b.length),this.sortFacet=c,this.tiles=a,this.tiles=a.sort(this.SortBy(this.sortFacet,!1,function(a){return $.isNumeric(a)?a:a.toUpperCase()})),this.currentFilter=b,this.buckets=this.Bucketize(a,b,this.sortFacet),this.columnWidth=(this.width-this.offsetX)/this.buckets.length,this.canvasHeightUIAdjusted=this.height-62;var e=[];this.bigCount=0;for(var f=0;f<this.buckets.length;f++){var g=f%2==0?"graphview-bucket-dark":"graphview-bucket-light";e[f]="<div class='pv-viewarea-graphview-overlay-bucket "+g+"' id='pv-viewarea-graphview-overlay-bucket-"+f+"' style='width: "+(Math.floor(this.columnWidth)-4)+"px; height:"+this.height+"px; left:"+(f*this.columnWidth-2)+"px;'>",this.buckets[f].startRange==this.buckets[f].endRange?e[f]+="<div class='pv-viewarea-graphview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'>"+this.buckets[f].startRange+"</div></div>":e[f]+="<div class='pv-viewarea-graphview-overlay-buckettitle' style='top: "+(this.canvasHeightUIAdjusted+4)+"px;'>"+this.buckets[f].startRange+"<br/>to<br/>"+this.buckets[f].endRange+"</div></div>",this.bigCount<this.buckets[f].Ids.length&&(this.bigCount=this.buckets[f].Ids.length)}var h=$(".pv-viewarea-graphview-overlay");h.css("left",this.offsetX+"px"),$(".pv-viewarea-graphview-overlay div").fadeOut("slow",function(){$(this).remove()}),h.append(e.join("")),$(".pv-viewarea-graphview-overlay div").fadeIn("slow");for(var f=0;f<this.tiles.length;f++){this.tiles[f].startx=this.tiles[f].x,this.tiles[f].starty=this.tiles[f].y,this.tiles[f].startwidth=this.tiles[f].width,this.tiles[f].startheight=this.tiles[f].height;var i=$.inArray(this.tiles[f].facetItem.Id,b);i<0&&(this.SetOuterTileDestination(this.width,this.height,this.tiles[f]),this.tiles[f].start=PivotViewer.Utils.Now(),this.tiles[f].end=this.tiles[f].start+1e3)}var j=b.length==this.tiles.length?0:500;setTimeout(function(){d.rowscols=d.GetRowsAndColumns(d.columnWidth-2,d.canvasHeightUIAdjusted,d.ratio,d.bigCount),d.SetVisibleTileGraphPositions(d.rowscols,d.offsetX,d.offsetY,!1,!1)},j),this.init=!1},GetUI:function(){return Modernizr.canvas?"<div class='pv-viewarea-graphview-overlay'></div>":"<div class='pv-viewpanel-unabletodisplay'><h2>Unfortunately this view is unavailable as your browser does not support this functionality.</h2>Please try again with one of the following supported browsers: IE 9+, Chrome 4+, Firefox 2+, Safari 3.1+, iOS Safari 3.2+, Opera 9+<br/><a href='http://caniuse.com/#feat=canvas'>http://caniuse.com/#feat=canvas</a></div>"},GetButtonImage:function(){return"Content/images/GraphView.png"},GetButtonImageSelected:function(){return"Content/images/GraphViewSelected.png"},GetViewName:function(){return"Graph View"},SetVisibleTileGraphPositions:function(a,b,c,d,e){var f=e?this.rowscols.Columns:a.Columns;e||(this.rowscols=a);for(var g=0;g<this.buckets.length;g++){var h=0,i=0;for(var j=0,k=this.tiles.length;j<k;j++)$.inArray(this.tiles[j].facetItem.Id,this.buckets[g].Ids)>=0&&(d&&(this.tiles[j].startx=this.tiles[j].x,this.tiles[j].starty=this.tiles[j].y,this.tiles[j].startwidth=this.tiles[j].width,this.tiles[j].startheight=this.tiles[j].height),this.tiles[j].destinationwidth=a.TileWidth,this.tiles[j].destinationheight=a.TileHeight,this.tiles[j].destinationx=g*this.columnWidth+h*a.TileWidth+b,this.tiles[j].destinationy=this.canvasHeightUIAdjusted-a.TileHeight-i*a.TileHeight+c,this.tiles[j].start=PivotViewer.Utils.Now(),this.tiles[j].end=this.tiles[j].start+1e3,h==f-1?(h=0,i++):h++)}},Bucketize:function(a,b,c){var d=[];for(var e=0;e<a.length;e++)if($.inArray(a[e].facetItem.Id,b)>=0){var f=!1;for(var g=0;g<a[e].facetItem.Facets.length;g++)if(a[e].facetItem.Facets[g].Name==c&&a[e].facetItem.Facets[g].FacetValues.length>0){var h=a[e].facetItem.Facets[g].FacetValues[0].Value,i=!1;for(var j=0;j<d.length;j++)d[j].startRange==h&&(d[j].Ids.push(a[e].facetItem.Id),i=!0);i||d.push({startRange:h,endRange:h,Ids:[a[e].facetItem.Id]}),f=!0}if(!f){var h="(no info)",i=!1;for(var j=0;j<d.length;j++)d[j].startRange==h&&(d[j].Ids.push(a[e].facetItem.Id),i=!0);i||d.push({startRange:h,endRange:h,Ids:[a[e].facetItem.Id]})}}var k=0;while(d.length>8)if(k<d.length-1){d[k].endRange=d[k+1].endRange;for(var e=0;e<d[k+1].Ids.length;e++)d[k].Ids.push(d[k+1].Ids[e]);d.splice(k+1,1),k++}else k=0;return d}}),PivotViewer.Views.IImageController=Object.subClass({init:function(){},Setup:function(a){},GetImagesAtLevel:function(a,b){},Width:0,Height:0}),PivotViewer.Views.LoadImageSetHelper=Object.subClass({init:function(){this._images=[],this._loaded=!1},LoadImages:function(a){var b=this;for(var c=0;c<a.length;c++){var d=new Image;d.src=a[c],d.onload=function(){b._loaded=!0},this._images.push(d)}},GetImages:function(){return this._images},IsLoaded:function(){return this._loaded}}),PivotViewer.Views.DeepZoomImageController=PivotViewer.Views.IImageController.subClass({init:function(){this._items=[],this._collageItems=[],this._baseUrl="",this._collageMaxLevel=0,this._tileSize=256,this._maxLevel=0,this._zooming=!1;var a=this;$.subscribe("/PivotViewer/ImageController/Zoom",function(b){a._zooming=b})},Setup:function(a){this._baseUrl=a.substring(0,a.lastIndexOf("/")),this._collageUrl=a.substring(a.lastIndexOf("/")+1).replace(".xml","_files");var b=this;$.ajax({type:"GET",url:a,dataType:"xml",success:function(a){var c=$(a).find("I");if(c.length==0)return;var d=$(c[0]).find("Size");if(d.length>0){b.Width=parseInt(d.attr("Width")),b.Height=parseInt(d.attr("Height"));var e=b.Width>b.Height?b.Width:b.Height;b._maxLevel=Math.ceil(Math.log(e)/Math.log(2))}var f=$(c[0]).attr("Source");$.ajax({type:"GET",url:b._baseUrl+"/"+f,dataType:"xml",success:function(a){var c=$(a).find("Image");if(c.length==0)return;var d=$(c[0]);b._tileSize=d.attr("TileSize"),b._tileFormat=d.attr("Format"),b._collageMaxLevel=d.attr("MaxLevel");var e=d.children().first();b.Width=parseInt(e.attr("Width")),b.Height=parseInt(e.attr("Height"));var f=b.Width>b.Height?b.Width:b.Height;b._maxLevel=Math.ceil(Math.log(f)/Math.log(2))},complete:function(a,d){for(var e=0;e<c.length;e++){var f=$(c[e]).attr("Source"),g=$(c[e]).attr("Id"),h=$(c[e]).attr("N"),i=f.substring(f.lastIndexOf("/")+1).replace(/\.xml/gi,"").replace(/\.dzi/gi,""),j=f.substring(0,f.lastIndexOf("/"));j.length>0&&(j+="/"),b._items.push(new PivotViewer.Views.DeepZoomItem(g,i,h,j))}$.publish("/PivotViewer/ImageController/Collection/Loaded",null)},error:function(a,b,c){$(".pv-loading").remove()}})},error:function(a,b,c){$(".pv-loading").remove();var d="";d+="Error loading from DeepZoom Cache\r\n\r\n",d=d+"URL        : "+this.url+"\r\n",d=d+"Statuscode : "+a.status+"\r\n",d=d+"Details    : "+c+"\r\n",d+="\r\nPivot Viewer cannot continue until this problem is resolved\r\r",window.alert(d)}})},GetImagesAtLevel:function(a,b){b=b>7?7:b,b=b<=0?6:b;for(var c=0;c<this._items.length;c++)if(this._items[c].ItemId==a){var d=this._items[c].DZN.toString(2),e="",f="";for(var g=0;g<d.length;g++)g%2==0?e+=d[g]:f+=d[g];dzCol=parseInt(e,2),dzRow=parseInt(f,2);if(this._items[c].Levels!=undefined&&this._items[c].Levels.length!=0||!!this._zooming){if(this._items[c].Levels.length<b&&!this._zooming){var h=this.GetImageList(this._baseUrl+"/"+this._items[c].BasePath+this._items[c].DZId+"_files/"+b+"/",b),i=new PivotViewer.Views.LoadImageSetHelper;i.LoadImages(h),this._items[c].Levels.splice(b,0,i)}for(var j=b;j>-1;j--){if(this._items[c].Levels[j]!=undefined&&this._items[c].Levels[j].IsLoaded())return this._items[c].Levels[j].GetImages();if(j==b&&this._items[c].Levels[j]==undefined&&!this._zooming){var h=this.GetImageList(this._baseUrl+"/"+this._items[c].BasePath+this._items[c].DZId+"_files/"+j+"/",j),i=new PivotViewer.Views.LoadImageSetHelper;i.LoadImages(h),this._items[c].Levels.splice(j,0,i)}}return null}var h=this.GetImageList(this._baseUrl+"/"+this._items[c].BasePath+this._items[c].DZId+"_files/6/",6),i=new PivotViewer.Views.LoadImageSetHelper;return i.LoadImages(h),this._items[c].Levels.push(i),null}return null},GetImageList:function(a,b){var c=[],d=Math.ceil(this.Width/Math.pow(2,this._maxLevel-b)),e=Math.ceil(this.Height/Math.pow(2,this._maxLevel-b)),f=Math.ceil(d/this._tileSize),g=Math.ceil(e/this._tileSize);for(var h=0;h<f;h++)for(var i=0;i<g;i++)c.push(a+h+"_"+i+"."+this._tileFormat);return c}}),PivotViewer.Views.DeepZoomItem=Object.subClass({init:function(a,b,c,d){this.ItemId=a,this.DZId=b,this.DZN=parseInt(c),this.BasePath=d,this.Levels=[]}}),PivotViewer.Views.TileController=Object.subClass({init:function(a){this._tiles=[],this._helpers=[],this._helperText="",this._easing=new Easing.Easer({type:"circular",side:"both"}),this._imageController=a},initTiles:function(a,b,c){for(var d=0;d<a.length;d++){var e=new PivotViewer.Views.Tile(this._imageController);e.facetItem=a[d],e.CollectionRoot=b.replace(/\\/gi,"/").replace(/\.xml/gi,""),this._canvasContext=c,e.context=this._canvasContext,this._tiles.push(e)}return this._tiles},AnimateTiles:function(){var a=this;this._started=!0;var b=null,c=!1;if(this._tiles.length>0&&this._tiles[0].context!=null){b=this._tiles[0].context;var d=!1;for(var e=0;e<this._tiles.length;e++){var f=PivotViewer.Utils.Now()-this._tiles[e].start,g=this._tiles[e].end-this._tiles[e].start;if(f<=g){if(this._tiles[e].x!=this._tiles[e].destinationx||this._tiles[e].y!=this._tiles[e].destinationy)d=!0;this._tiles[e].x=this._easing.ease(f,this._tiles[e].startx,this._tiles[e].destinationx-this._tiles[e].startx,g),this._tiles[e].y=this._easing.ease(f,this._tiles[e].starty,this._tiles[e].destinationy-this._tiles[e].starty,g);if(this._tiles[e].width!=this._tiles[e].destinationWidth||this._tiles[e].height!=this._tiles[e].destinationHeight)d=!0;this._tiles[e].width=this._easing.ease(f,this._tiles[e].startwidth,this._tiles[e].destinationwidth-this._tiles[e].startwidth,g),this._tiles[e].height=this._easing.ease(f,this._tiles[e].startheight,this._tiles[e].destinationheight-this._tiles[e].startheight,g)}else this._tiles[e].x=this._tiles[e].destinationx,this._tiles[e].y=this._tiles[e].destinationy,this._tiles[e].width=this._tiles[e].destinationwidth,this._tiles[e].height=this._tiles[e].destinationheight;this._tiles[e].destinationx+this._tiles[e].destinationwidth<0||this._tiles[e].destinationx>b.canvas.width||this._tiles[e].destinationy+this._tiles[e].destinationheight<0||this._tiles[e].destinationy>b.canvas.height?this._tiles[e].destinationVisible=!1:this._tiles[e].destinationVisible=!0}}this._isZooming!=d&&(this._isZooming=d,$.publish("/PivotViewer/ImageController/Zoom",[this._isZooming])),b.clearRect(0,0,b.canvas.width,b.canvas.height);for(var e=0;e<this._tiles.length;e++)this._tiles[e].x+this._tiles[e].width>0&&this._tiles[e].x<b.canvas.width&&this._tiles[e].y+this._tiles[e].height>0&&this._tiles[e].y<b.canvas.height&&(c?this._tiles[e].DrawEmpty():this._tiles[e].Draw());if(!!this._breaks){this._started=!1;return}requestAnimFrame(function(){a.AnimateTiles()})},BeginAnimation:function(){!this._started&&this._tiles.length>0&&(this._breaks=!1,this.AnimateTiles())},StopAnimation:function(){this._breaks=!0},SetLinearEasingBoth:function(){this._easing=new Easing.Easer({type:"linear",side:"both"})},SetCircularEasingBoth:function(){this._easing=new Easing.Easer({type:"circular",side:"both"})},SetQuarticEasingOut:function(){this._easing=new Easing.Easer({type:"quartic",side:"out"})},GetTileRaio:function(){return this._imageController.Height/this._imageController.Width},DrawHelpers:function(a){this._helpers=a},DrawHelperText:function(a){this._helperText=a}}),PivotViewer.Views.Tile=Object.subClass({init:function(a){if(!(this instanceof PivotViewer.Views.Tile))return new PivotViewer.Views.Tile(a);this._controller=a,this._imageLoaded=!1,this._selected=!1,this._level=0,this._images=null},Draw:function(){if(this.destinationVisible){var a=this.width>this.height?this.width:this.height,b=Math.ceil(Math.log(a)/Math.log(2));if(b==Infinity||b==-Infinity)b=0;this._level=b,this._images=this._controller.GetImagesAtLevel(this.facetItem.Img,this._level)}if(this._images!=null){if(typeof this._images=="function")this._images(this.facetItem,this.context,this.x+2,this.y+2,this.width-4,this.height-4);else if(this._images.length>0&&this._images[0]instanceof Image)for(var c=0;c<this._images.length;c++)this.context.drawImage(this._images[c],this.x+2,this.y+2,this.width-4,this.height-4)}else this.DrawEmpty();this._selected&&(this.context.beginPath(),this.context.rect(this.x+2,this.y+2,this.width-4,this.height-4),this.context.lineWidth=4,this.context.strokeStyle="#92C4E1",this.context.stroke())},Contains:function(a,b){return this.x<=a&&this.x+this.width>=a&&this.y<=b&&this.y+this.height>=b},DrawEmpty:function(){this._controller.DrawLevel==undefined?(this.context.beginPath(),this.context.fillStyle="#D7DDDD",this.context.fillRect(this.x+2,this.y+2,this.width-4,this.height-4),this.context.rect(this.x+2,this.y+2,this.width-4,this.height-4),this.context.lineWidth=1,this.context.strokeStyle="white",this.context.stroke()):this._controller.DrawLevel(this.facetItem,this.context,this.x+2,this.y+2,this.width-4,this.height-4)},CollectionRoot:"",now:null,end:null,x:0,y:0,startx:0,starty:0,destinationx:0,destinationy:0,width:0,height:0,startwidth:0,startheight:0,destinationwidth:0,destinationheight:0,destinationVisible:!0,context:null,facetItem:null,Selected:function(a){this._selected=a}}),function(a){var b=
[],c=[],d=[],e=[],f=0,g,h,i=[],j,k=null,l=null,m={View:null,Facet:null,Filters:[]},n=null,o=0,p=new PivotViewer.Models.Collection,q={init:function(a){n=this,n.addClass("pv-wrapper"),InitPreloader();if(a.Loader==undefined)throw"Collection loader is undefined.";if(!(a.Loader instanceof PivotViewer.Models.Loaders.ICollectionLoader))throw"Collection loader does not inherit from PivotViewer.Models.Loaders.ICollectionLoader.";a.Loader.LoadCollection(p);if(a.ImageController==undefined)j=new PivotViewer.Views.DeepZoomImageController;else{if(!a.ImageController instanceof PivotViewer.Views.IImageController)throw"Image Controller does not inherit from PivotViewer.Views.IImageController.";j=a.ImageController}if(a.ViewerState!=undefined){var b=a.ViewerState.split("&");for(var c=0,d=b.length;c<d;c++){var e=b[c].split("=");if(e.length==2)if(e[0]=="$view$")m.View=parseInt(e[1])-1;else if(e[0]=="$facet0$")m.Facet=PivotViewer.Utils.EscapeItemId(e[1]);else{var f={Facet:e[0],Predicates:[]},g=e[1].split("_");for(var h=0,i=g.length;h<i;h++){var k=g[h].split(".");k.length==2&&f.Predicates.push({Operator:k[0],Value:k[1]})}m.Filters.push(f)}}}},show:function(){Debug.Log("Show")},hide:function(){Debug.Log("Hide")}};InitPreloader=function(){n.append("<div class='pv-loading'><img src='Content/images/loading.gif' alt='Loading' /><span>Loading...</span></div>"),a(".pv-loading").css("top",a(".pv-wrapper").height()/2-33+"px"),a(".pv-loading").css("left",a(".pv-wrapper").width()/2-43+"px")},InitTileCollection=function(){InitUI();var b=p.ImageBase;b.indexOf("http",0)>=0||b.indexOf("www.",0)>=0||(b=p.CXMLBase.substring(0,p.CXMLBase.lastIndexOf("/")+1)+b);var c=a(".pv-viewarea-canvas")[0].getContext("2d");h=new PivotViewer.Views.TileController(j),i=h.initTiles(p.Items,b,c),j.Setup(b.replace("\\","/"))},InitPivotViewer=function(){CreateFacetList(),CreateViews(),AttachEventHandlers(),a(".pv-loading").remove(),ApplyViewerState(),m.View!=null?SelectView(m.View,!0):SelectView(0,!0),h.BeginAnimation()},InitUI=function(){var b="<div class='pv-toolbarpanel'>",c=p.BrandImage;c.length>0&&(b+="<img class='pv-toolbarpanel-brandimage' src='"+c+"'></img>"),b+="<span class='pv-toolbarpanel-name'>"+p.CollectionName+"</span>",b+="<div class='pv-toolbarpanel-facetbreadcrumb'></div>",b+="<div class='pv-toolbarpanel-zoomcontrols'><div class='pv-toolbarpanel-zoomslider'></div></div>",b+="<div class='pv-toolbarpanel-viewcontrols'></div>",b+="<div class='pv-toolbarpanel-sortcontrols'></div>",b+="</div>",n.append(b);var d=o;a(".pv-toolbarpanel-zoomslider").slider({max:10,slide:function(b,c){var e=c.value<d?c.value*-1:c.value;a.publish("/PivotViewer/Views/Canvas/Zoom",[{x:201,y:0,delta:.75*e}]),d=c.value}}),n.append("<div class='pv-mainpanel'></div>");var e=a(".pv-wrapper").height()-a(".pv-toolbarpanel").height()-6;a(".pv-mainpanel").css("height",e+"px"),a(".pv-mainpanel").append("<div class='pv-filterpanel'></div>"),a(".pv-mainpanel").append("<div class='pv-viewpanel'><canvas class='pv-viewarea-canvas' width='"+n.width()+"' height='"+e+"px'></canvas></div>"),a(".pv-mainpanel").append("<div class='pv-infopanel'></div>");var f=a(".pv-filterpanel");f.append("<div class='pv-filterpanel-clearall'>Clear All</div>").append("<input class='pv-filterpanel-search' type='text' placeholder='Search...' /><div class='pv-filterpanel-search-autocomplete'></div>").css("height",e-13+"px"),a(".pv-filterpanel-search").css("width",f.width()-2+"px"),a(".pv-filterpanel-search-autocomplete").css("width",f.width()-8+"px").hide();var g=a(".pv-infopanel");g.css("left",a(".pv-mainpanel").offset().left+a(".pv-mainpanel").width()-205+"px").css("height",e-28+"px"),g.append("<div class='pv-infopanel-controls'></div>"),a(".pv-infopanel-controls").append("<div><div class='pv-infopanel-controls-navleft'></div><div class='pv-infopanel-controls-navbar'></div><div class='pv-infopanel-controls-navright'></div></div>"),g.append("<div class='pv-infopanel-heading'></div>"),g.append("<div class='pv-infopanel-details'></div>"),g.hide()},CreateFacetList=function(){for(var b=0;b<p.Items.length;b++){var f=p.Items[b];for(var g=0;g<p.FacetCategories.length;g++){var h=p.FacetCategories[g];if(h.IsFilterVisible){var i=!1;for(var j=0,k=f.Facets.length;j<k;j++){var l=f.Facets[j];if(l.Name==h.Name){for(var m=0;m<l.FacetValues.length;m++)if(h.Type==PivotViewer.Models.FacetType.String){var n=!1,o=PivotViewer.Utils.EscapeItemId("pv-facet-item-"+l.Name+"__"+l.FacetValues[m].Value);for(var q=c.length-1;q>-1;q-=1)if(c[q].itemId==o){c[q].count+=1,n=!0;break}n||c.push({itemId:o,itemValue:l.FacetValues[m].Value,facet:l.Name,count:1})}else if(h.Type==PivotViewer.Models.FacetType.Number){var r=!1;for(var q=0;q<d.length;q++)if(d[q].Facet==f.Facets[j].Name){d[q].Values.push(l.FacetValues[m].Value),r=!0;break}r||d.push({Facet:l.Name,Values:[l.FacetValues[m].Value]})}i=!0}}if(!i){var n=!1,o=PivotViewer.Utils.EscapeItemId("pv-facet-item-"+h.Name+"__(no info)");for(var q=c.length-1;q>-1;q-=1)if(c[q].itemId==o){c[q].count+=1,n=!0;break}n||c.push({itemId:o,itemValue:"(no info)",facet:h.Name,count:1})}}if(h.IsWordWheelVisible)for(var j=0,k=f.Facets.length;j<k;j++){var l=f.Facets[j];if(l.Name==h.Name)for(var m=0;m<l.FacetValues.length;m++)h.Type==PivotViewer.Models.FacetType.String&&e.push({Facet:l.Name,Value:l.FacetValues[m].Value})}}}var s=["<div class='pv-filterpanel-accordion'>"],t=[];for(var b=0;b<p.FacetCategories.length;b++)p.FacetCategories[b].IsFilterVisible&&(s[b+1]="<h3><a href='#'>",s[b+1]+=p.FacetCategories[b].Name,s[b+1]+="</a><div class='pv-filterpanel-accordion-heading-clear' facetType='"+p.FacetCategories[b].Type+"'>&nbsp;</div></h3>",s[b+1]+="<div id='pv-cat-"+PivotViewer.Utils.EscapeItemId(p.FacetCategories[b].Name)+"'>",p.FacetCategories[b].Type==PivotViewer.Models.FacetType.String?(p.FacetCategories[b].CustomSort!=undefined||p.FacetCategories[b].CustomSort!=null?s[b+1]+="<span class='pv-filterpanel-accordion-facet-sort' customSort='"+p.FacetCategories[b].CustomSort.Name+"'>Sort: "+p.FacetCategories[b].CustomSort.Name+"</span>":s[b+1]+="<span class='pv-filterpanel-accordion-facet-sort'>Sort: A-Z</span>",s[b+1]+=CreateStringFacet(p.FacetCategories[b].Name)):p.FacetCategories[b].Type==PivotViewer.Models.FacetType.Number&&(s[b+1]+="<div id='pv-filterpanel-category-numberitem-"+p.FacetCategories[b].Name.replace(/\s+/gi,"|")+"'></div>"),s[b+1]+="</div>",t[b]="<option value='"+PivotViewer.Utils.EscapeItemId(p.FacetCategories[b].Name)+"' label='"+p.FacetCategories[b].Name+"'>"+p.FacetCategories[b].Name+"</option>");s[s.length]="</div>",a(".pv-filterpanel").append(s.join(""));for(var b=0;b<p.FacetCategories.length;b++)p.FacetCategories[b].IsFilterVisible&&SortFacetItems(p.FacetCategories[b].Name);a(".pv-filterpanel-accordion").css("height",a(".pv-filterpanel").height()-a(".pv-filterpanel-search").height()-50+"px"),a(".pv-filterpanel-accordion").accordion({fillSpace:!0}),a(".pv-toolbarpanel-sortcontrols").append('<select class="pv-toolbarpanel-sort">'+t.join("")+"</select>");for(var b=0;b<d.length;b++)CreateNumberFacet(PivotViewer.Utils.EscapeItemId(d[b].Facet),d[b].Values)},CreateStringFacet=function(a){var b=["<ul class='pv-filterpanel-accordion-facet-list'>"];for(var d=0;d<c.length;d++)c[d].facet==a&&(b[d+1]="<li class='pv-filterpanel-accordion-facet-list-item'  id='"+c[d].itemId+"'>",b[d+1]+="<input itemvalue='"+c[d].itemValue.replace(/\s+/gi,"|")+"' itemfacet='"+a.replace(/\s+/gi,"|")+"' class='pv-facet-facetitem' type='checkbox' />",b[d+1]+="<span class='pv-facet-facetitem-label' title='"+c[d].itemValue+"'>"+c[d].itemValue+"</span>",b[d+1]+="<span class='pv-facet-facetitem-count'>0</span>",b[d+1]+="</li>");return b[b.length]="</ul>",b.join("")},CreateNumberFacet=function(b,c){var d=165,e=80,f=a("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.EscapeMetaChars(b));f.empty(),f.append("<span class='pv-filterpanel-numericslider-range-val'>&nbsp;</span>");var g="<svg class='pv-filterpanel-accordion-facet-chart' width='"+d+"' height='"+e+"'>",h=PivotViewer.Utils.Histogram(c),i=.5+d/h.BinCount|0,j=0;for(var k=0,l=h.Histogram.length;k<l;k++)j=j<h.Histogram[k].length?h.Histogram[k].length:j;for(var k=0,l=h.Histogram.length;k<l;k++){var m=.5+e/(j/h.Histogram[k].length)|0,n=.5+i*k|0;g+="<rect x='"+n+"' y='"+(e-m)+"' width='"+i+"' height='"+m+"'></rect>"}f.append(g+"</svg>");var o=a("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.EscapeMetaChars(b));o.append('</span><div id="pv-filterpanel-numericslider-'+b+'" class="pv-filterpanel-numericslider"></div><span class="pv-filterpanel-numericslider-range-min">'+h.Min+'</span><span class="pv-filterpanel-numericslider-range-max">'+h.Max+"</span>");var p=a("#pv-filterpanel-numericslider-"+PivotViewer.Utils.EscapeMetaChars(b));p.slider({range:!0,min:h.Min,max:h.Max,values:[h.Min,h.Max],slide:function(b,c){a(this).parent().find(".pv-filterpanel-numericslider-range-val").text(c.values[0]+" - "+c.values[1])},stop:function(b,c){var d=a(this),e=d.slider("option","min"),f=d.slider("option","max");c.values[0]>e||c.values[1]<f?d.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible"):c.values[0]==e&&c.values[1]==f&&d.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden"),FilterCollection()}})},CreateViews=function(){var c=a(".pv-viewpanel"),d=n.width(),e=a(".pv-mainpanel").height(),f=a(".pv-filterpanel").width()+18,g=4;b.push(new PivotViewer.Views.GridView),b.push(new PivotViewer.Views.GraphView);for(var i=0;i<b.length;i++)try{b[i]instanceof PivotViewer.Views.IPivotViewerView?(b[i].Setup(d,e,f,g,h.GetTileRaio()),c.append("<div class='pv-viewpanel-view' id='pv-viewpanel-view-"+i+"'>"+b[i].GetUI()+"</div>"),a(".pv-toolbarpanel-viewcontrols").append("<div class='pv-toolbarpanel-view' id='pv-toolbarpanel-view-"+i+"' title='"+b[i].GetViewName()+"'><img id='pv-viewpanel-view-"+i+"-image' src='"+b[i].GetButtonImage()+"' alt='"+b[i].GetViewName()+"' /></div>")):alert("View does not inherit from PivotViewer.Views.IPivotViewerView")}catch(j){alert(j.Message)}},SelectView=function(c,d){for(var e=0;e<b.length;e++)c!=e&&(a("#pv-viewpanel-view-"+e+"-image").attr("src",b[e].GetButtonImage()),b[e].Deactivate(),b[e].init=!1);a("#pv-viewpanel-view-"+c+"-image").attr("src",b[c].GetButtonImageSelected()),b[c].Activate(),b[c].init=d,f=c,FilterCollection()},SortFacetItems=function(b){var c=a("#pv-cat-"+PivotViewer.Utils.EscapeMetaChars(PivotViewer.Utils.EscapeItemId(b))+" ul"),d=c.prev().text().replace("Sort: ",""),e=c.children("li").get();if(d=="A-Z")e.sort(function(b,c){var d=a(b).children().first().attr("itemvalue"),e=a(c).children().first().attr("itemvalue");return d<e?1:d>e?-1:0});else if(d=="Quantity")e.sort(function(b,c){var d=parseInt(a(b).children(".pv-facet-facetitem-count").text()),e=parseInt(a(c).children(".pv-facet-facetitem-count").text());return d<e?-1:d>e?1:0});else{var f=p.GetFacetCategoryByName(b);if(f.CustomSort!=undefined){var g=[];for(var h=f.CustomSort.SortValues.length-1;h>-1;h-=1)for(var i=0;i<e.length;i++)f.CustomSort.SortValues[h]==a(e[i]).children(".pv-facet-facetitem-label").text()&&(g.push(e[i]),found=!0);e=g}}for(var h=0;h<e.length;h++)c.prepend(e[h])},ApplyViewerState=function(){m.Facet!=null&&a(".pv-toolbarpanel-sort").val(m.Facet).attr("selected","selected");for(var b=0,c=m.Filters.length;b<c;b++)for(var d=0,e=m.Filters[b].Predicates.length;d<e;d++){var f=m.Filters[b].Predicates[d].Operator;if(f=="GT"||f=="GE"||f=="LT"||f=="LE"){var g=a("#pv-filterpanel-numericslider-"+PivotViewer.Utils.EscapeItemId(m.Filters[b].Facet)),h=parseFloat(m.Filters[b].Predicates[d].Value);switch(f){case"GT":g.slider("values",0,h+1);break;case"GE":g.slider("values",0,h);break;case"LT":g.slider("values",1,h-1);break;case"LE":g.slider("values",1,h)}g.parent().find(".pv-filterpanel-numericslider-range-val").text(g.slider("values",0)+" - "+g.slider("values",1)),g.parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")}else f=="EQ"?SelectStringFacetItem(PivotViewer.Utils.EscapeItemId(m.Filters[b].Facet),PivotViewer.Utils.EscapeItemId(m.Filters[b].Predicates[d].Value)):f=="NT"&&SelectStringFacetItem(PivotViewer.Utils.EscapeItemId(m.Filters[b].Facet),"(no|info)")}},SelectStringFacetItem=function(b,c){var d=a('.pv-facet-facetitem[itemfacet="'+b+'"][itemvalue="'+c+'"]');d.attr("checked","checked"),d.parent().parent().parent().prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible")},FilterCollection=function(){var c=[],d=[],e=[],g=a(".pv-toolbarpanel-sort option:selected").text(),j=a(".pv-facet-facetitem:checked");a(".pv-filterpanel-clearall").css("visibility","hidden");var k=[];for(var l=0;l<j.length;l++){var m=a(j[l]).attr("itemfacet").replace(/\|/gi," "),n=a(j[l]).attr("itemvalue").replace(/\|/gi," "),o=!1;for(var q=0;q<k.length;q++)k[q].facet==m&&(k[q].facetValue.push(n),o=!0);o||k.push({facet:m,facetValue:[n]}),a.inArray(m,e)<0&&e.push(m)}var r=[];for(var l=0,s=p.FacetCategories.length;l<s;l++)if(p.FacetCategories[l].Type==PivotViewer.Models.FacetType.Number){var t=a("#pv-filterpanel-category-numberitem-"+PivotViewer.Utils.EscapeMetaChars(p.FacetCategories[l].Name.replace(/\s+/gi,"|"))),u=a(t).find(".pv-filterpanel-numericslider");if(u.length>0){var v=u.slider("values"),w=u.slider("option","max"),x=u.slider("option","min");if(v[0]!=x||v[1]!=w){var m=p.FacetCategories[l].Name;r.push({facet:m,selectedMin:v[0],selectedMax:v[1],rangeMin:x,rangeMax:w}),a.inArray(m,e)<0&&e.push(m)}}}for(var l=0,s=p.Items.length;l<s;l++){var y=0;for(var q=0,z=p.Items[l].Facets.length;q<z;q++)for(var A=0,B=k.length;A<B;A++)if(p.Items[l].Facets[q].Name==k[A].facet)for(var C=0,D=p.Items[l].Facets[q].FacetValues.length;C<D;C++)for(var E=0,F=k[A].facetValue.length;E<F;E++)p.Items[l].Facets[q].FacetValues[C].Value==k[A].facetValue[E]&&y++;if(y!=k.length)continue;for(var q=0,z=p.Items[l].Facets.length;q<z;q++)for(var A=0,B=r.length;A<B;A++)if(p.Items[l].Facets[q].Name==r[A].facet)for(var C=0,D=p.Items[l].Facets[q].FacetValues.length;C<D;C++){var G=parseFloat(p.Items[l].Facets[q].FacetValues[C].Value);!isNaN(G)&&G>=r[A].selectedMin&&G<=r[A].selectedMax&&y++}if(y!=k.length+r.length)continue;c.push(p.Items[l].Id),k.length+r.length>0&&a(".pv-filterpanel-clearall").css("visibility","visible")}a(".pv-viewpanel-view").hide(),a("#pv-viewpanel-view-"+f).show(),FilterFacets(c,e),UpdateBreadcrumbNavigation(k,r),h.SetCircularEasingBoth(),b[f].Filter(i,c,g),a.publish("/PivotViewer/Views/Item/Deselected",null),DeselectInfoPanel()},FilterFacets=function(b,e){if(b.length==p.Items.length){for(var f=c.length-1;f>-1;f-=1){var g=a("#"+PivotViewer.Utils.EscapeMetaChars(c[f].itemId));g.show(),g.find("span").last().text(c[f].count)}for(var f=0;f<d.length;f++)CreateNumberFacet(PivotViewer.Utils.EscapeItemId(d[f].Facet),d[f].Values);return}var h=[],i=[];for(var f=b.length-1;f>-1;f-=1){var g=p.GetItemById(b[f]);for(var j=0;j<p.FacetCategories.length;j++)if(p.FacetCategories[j].IsFilterVisible){var k=!1;for(var l=g.Facets.length-1;l>-1;l-=1)if(g.Facets[l].Name==p.FacetCategories[j].Name){if(a.inArray(g.Facets[l].Name,e)<0){var m=p.GetFacetCategoryByName(g.Facets[l].Name);if(m.IsFilterVisible)for(var n=g.Facets[l].FacetValues.length-1;n>-1;n-=1)if(m.Type==PivotViewer.Models.FacetType.String){var o={item:"#"+PivotViewer.Utils.EscapeMetaChars(PivotViewer.Utils.EscapeItemId("pv-facet-item-"+g.Facets[l].Name+"__"+g.Facets[l].FacetValues[n].Value)),count:1},q=!1;for(var r=h.length-1;r>-1;r-=1)if(h[r].item==o.item){h[r].count+=1,q=!0;break}q||h.push(o)}else if(m.Type==PivotViewer.Models.FacetType.Number){var s=!1;for(var r=0;r<i.length;r++)if(i[r].Facet==g.Facets[l].Name){i[r].Values.push(g.Facets[l].FacetValues[n].Value),s=!0;break}s||i.push({Facet:g.Facets[l].Name,Values:[g.Facets[l].FacetValues[n].Value]})}}k=!0}if(!k){var o={item:"#"+PivotViewer.Utils.EscapeMetaChars(PivotViewer.Utils.EscapeItemId("pv-facet-item-"+p.FacetCategories[j].Name+"__(no info)")),count:1},q=!1;for(var r=h.length-1;r>-1;r-=1)if(h[r].item==o.item){h[r].count+=1,q=!0;break}q||h.push(o)}}}for(var f=c.length-1;f>-1;f-=1)if(a.inArray(c[f].facet,e)<0){var q=!1;for(var l=h.length-1;l>-1;l-=1)if(h[l].item==c[f].itemId){q=!0;break}q||a("#"+PivotViewer.Utils.EscapeMetaChars(c[f].itemId)).hide()}else a("#"+PivotViewer.Utils.EscapeMetaChars(c[f].itemId)).find("span").last().text(c[f].count);for(var f=h.length-1;f>-1;f-=1){var t=a(h[f].item);if(t.length>0){t.show();var u=t.find("span").last();u.text(h[f].count)}}for(var f=0;f<i.length;f++)CreateNumberFacet(PivotViewer.Utils.EscapeItemId(i[f].Facet),i[f].Values)},UpdateBreadcrumbNavigation=function(b,c){var d=a(".pv-toolbarpanel-facetbreadcrumb");d.empty();if(b.length==0)return;var e="|";for(var f=0,g=b.length;f<g;f++)e+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+b[f].facet+":</span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",e+=b[f].facetValue.join(", "),e+="</span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;</span>";for(var f=0,g=c.length;f<g;f++)e+="<span class='pv-toolbarpanel-facetbreadcrumb-facet'>"+c[f].facet+":</span><span class='pv-toolbarpanel-facetbreadcrumb-values'>",c[f].selectedMin==c[f].rangeMin?e+="Under "+c[f].selectedMax:c[f].selectedMax==c[f].rangeMax?e+="Over "+c[f].selectedMin:e+=c[f].selectedMin+" - "+c[f].selectedMax,e+="</span><span class='pv-toolbarpanel-facetbreadcrumb-separator'>&gt;</span>";d.append(e)},DeselectInfoPanel=function(){a(".pv-infopanel").fadeOut(),a(".pv-infopanel-heading").text(""),a(".pv-infopanel-details").empty()},GetItemIds=function(a,b){var c=[];for(var d=0;d<p.Items.length;d++){var e=!1;for(var f=0;f<p.Items[d].Facets.length;f++)if(p.Items[d].Facets[f].Name==a){for(var g=0;g<p.Items[d].Facets[f].FacetValues.length;g++)b==p.Items[d].Facets[f].FacetValues[g].Value&&c.push(p.Items[d].Id);e=!0}!e&&b=="(no info)"&&c.push(p.Items[d].Id)}return c},GetItem=function(a){for(var b=0;b<p.Items.length;b++)if(p.Items[b].Id==a)return p.Items[b];return null},a.subscribe("/PivotViewer/Models/Collection/Loaded",function(a){InitTileCollection()}),a.subscribe("/PivotViewer/ImageController/Collection/Loaded",function(a){InitPivotViewer()}),a.subscribe("/PivotViewer/Views/Item/Selected",function(b){if(b==undefined||b==null){DeselectInfoPanel();return}var c=GetItem(b);if(c!=null){var d=!0;a(".pv-infopanel-heading").text(c.Name);var e=a(".pv-infopanel-details");e.empty(),c.Description!=undefined&&c.Description.length>0&&e.append("<div class='pv-infopanel-detail-description' style='height:100px;'>"+c.Description+"</div><div class='pv-infopanel-detail-description-more'>More</div>");var f=[],g=0;for(var h=0;h<c.Facets.length;h++){var i=!1,j=!1;for(var k=0;k<p.FacetCategories.length;k++)if(p.FacetCategories[k].Name==c.Facets[h].Name&&p.FacetCategories[k].IsMetaDataVisible){i=!0,j=p.FacetCategories[k].IsFilterVisible;break}if(i){f[g]="<div class='pv-infopanel-detail "+(d?"detail-dark":"detail-light")+"'><div class='pv-infopanel-detail-item detail-item-title'>"+c.Facets[h].Name+"</div>";for(var k=0;k<c.Facets[h].FacetValues.length;k++)f[g]+="<div class='pv-infopanel-detail-item detail-item-value"+(j?" detail-item-value-filter":"")+"'>",c.Facets[h].FacetValues[k].Href!=null?f[g]+="<a class='detail-item-link' href='"+c.Facets[h].FacetValues[k].Href+"'>"+c.Facets[h].FacetValues[k].Value+"</a>":f[g]+=c.Facets[h].FacetValues[k].Value,f[g]+="</div>";f[g]+="</div>",g++,d=!d}}e.append(f.join("")),a(".pv-infopanel").fadeIn(),e.css("height",a(".pv-infopanel").height()-(a(".pv-infopanel-controls").height()+a(".pv-infopanel-heading").height())-20+"px");return}}),a.subscribe("/PivotViewer/Views/Item/Filtered",function(b){if(b==undefined||b==null)return;var c=a(PivotViewer.Utils.EscapeMetaChars(PivotViewer.Utils.EscapeItemId("#pv-facet-item-"+b.Facet+"__"+b.Item))+" input");c.attr("checked","checked"),FacetItemClick(c[0])}),AttachEventHandlers=function(){a(".pv-toolbarpanel-view").on("click",function(a){var b=this.id.substring(this.id.lastIndexOf("-")+1,this.id.length);b!=null&&SelectView(parseInt(b),!1)}),a(".pv-toolbarpanel-sort").on("change",function(a){FilterCollection()}),a(".pv-filterpanel-accordion-facet-sort").on("click",function(b){var c=a(this),d=c.text(),e=c.parent().prev().children("a").text(),f=c.attr("customSort");d=="Sort: A-Z"?a(this).text("Sort: Quantity"):d=="Sort: Quantity"&&f==undefined?a(this).text("Sort: A-Z"):d=="Sort: Quantity"?a(this).text("Sort: "+f):a(this).text("Sort: A-Z"),SortFacetItems(e)}),a(".pv-facet-facetitem").on("click",function(a){FacetItemClick(this)}),a(".pv-facet-facetitem-label").on("click",function(b){var c=a(this).prev(),d=a(this.parentElement.parentElement).find(":checked");c.attr("checked")=="checked"&&d.length<=1?c.removeAttr("checked"):c.attr("checked","checked");for(var e=d.length-1;e>-1;e-=1)d[e].getAttribute("itemvalue")!=c[0].getAttribute("itemvalue")&&(d[e].checked=!1);FacetItemClick(c[0])}),a(".pv-filterpanel-clearall").on("click",function(b){var c=a(".pv-facet-facetitem:checked");for(var d=0;d<c.length;d++)a(c[d]).removeAttr("checked");var e=a(".pv-filterpanel-numericslider");for(var d=0;d<e.length;d++){var f=a(e[d]),g=f.slider("option","min"),h=f.slider("option","max");f.slider("values",0,g),f.slider("values",1,h),f.prev().prev().html("&nbsp;")}a(".pv-filterpanel-search").val(""),a(".pv-filterpanel-accordion-heading-clear").css("visibility","hidden"),FilterCollection()}),a(".pv-filterpanel-accordion-heading-clear").on("click",function(b){var c=this.attributes.facetType.value;if(c=="String"){var d=a(this.parentElement).next().find(".pv-facet-facetitem:checked");for(var e=0;e<d.length;e++)a(d[e]).removeAttr("checked")}else if(c=="Number"){var f=a(this.parentElement).next().find(".pv-filterpanel-numericslider"),g=f.slider("option","min"),h=f.slider("option","max");f.slider("values",0,g),f.slider("values",1,h),f.prev().prev().html("&nbsp;")}FilterCollection(),a(this).css("visibility","hidden")}),a(".ui-slider-range").on("mousedown",function(a){}),a(".pv-infopanel-details").on("click",".detail-item-value-filter",function(b){return a.publish("/PivotViewer/Views/Item/Filtered",[{Facet:a(this).parent().children().first().text(),Item:a(this).text()}]),!1}),a(".pv-infopanel-details").on("click",".pv-infopanel-detail-description-more",function(b){var c=a(this),d=a(this).prev();c.text()=="More"?(d.css("height",""),a(this).text("Less")):(d.css("height","100px"),a(this).text("More"))}),a(".pv-filterpanel-search").on("keyup",function(b){var c=!1,d=[],f=a(".pv-filterpanel-search-autocomplete"),g=FilterCollection,h=SelectStringFacetItem;f.empty();if(b.keyCode==27){a(b.target).blur();return}for(var i=0,j=e.length;i<j;i++){var k=e[i].Value.toLowerCase();k.indexOf(b.target.value.toLowerCase())>=0&&a.inArray(k,d)==-1&&(d.push(k),f.append('<span facet="'+e[i].Facet+'">'+e[i].Value+"</span>"),b.keyCode==13&&(SelectStringFacetItem(PivotViewer.Utils.EscapeItemId(e[i].Facet),PivotViewer.Utils.EscapeItemId(e[i].Value)),c=!0))}a(".pv-filterpanel-search-autocomplete > span").on("mousedown",function(b){b.preventDefault(),a(".pv-filterpanel-search").val(b.target.textContent),a(".pv-filterpanel-search-autocomplete").hide(),h(PivotViewer.Utils.EscapeItemId(b.target.attributes[0].value),PivotViewer.Utils.EscapeItemId(b.target.textContent)),g()}),d.length>0&&f.show(),c&&FilterCollection()}),a(".pv-filterpanel-search").on("blur",function(b){b.target.value="",a(".pv-filterpanel-search-autocomplete").hide()});var b=a(".pv-viewarea-canvas");b.on("mouseup",function(b){var c=a(this).offset(),d=b.clientX-c.left,e=b.clientY-c.top;(!l||l.x==0&&l.y==0)&&a.publish("/PivotViewer/Views/Canvas/Click",[{x:d,y:e}]),k=null,l=!1}),b.on("mouseout",function(a){k=null,l=!1}),b.on("mousedown",function(b){var c=a(this).offset(),d=b.clientX-c.left,e=b.clientY-c.top;k={x:d,y:e}}),b.on("mousemove",function(b){var c=a(this).offset(),d=b.clientX-c.left,e=b.clientY-c.top;k==null?a.publish("/PivotViewer/Views/Canvas/Hover",[{x:d,y:e}]):(l={x:d-k.x,y:e-k.y},k={x:d,y:e},a.publish("/PivotViewer/Views/Canvas/Drag",[l]))}),b.on("mousewheel",function(b,c){var d=a(this).offset(),e=b.clientX-d.left,f=b.clientY-d.top;h.SetQuarticEasingOut(),h.DrawHelpers([{x:e,y:f}]),a.publish("/PivotViewer/Views/Canvas/Zoom",[{x:e,y:f,delta:c}])}),b.on("touchstart",function(b){var c=b.originalEvent,d=a(this).offset(),e=c.touches[0].pageX-d.left,f=c.touches[0].pageY-d.top;k={x:e,y:f}}),b.on("touchmove",function(b){try{var c=b.originalEvent;b.preventDefault();if(c.touches.length>1){b.preventDefault();var d=1e7,e=1e7,f=0,g=0,i=[];for(var j=0;j<c.touches.length;j++)i.push({x:c.touches[j].pageX,y:c.touches[j].pageY}),c.touches[j].pageX<d&&(d=c.touches[j].pageX),c.touches[j].pageX>f&&(f=c.touches[j].pageX),c.touches[j].pageY<e&&(e=c.touches[j].pageY),c.touches[j].pageY>g&&(g=c.touches[j].pageY);var m=(d+f)/2,n=(e+g)/2;h.SetLinearEasingBoth(),i.push({x:m,y:n}),h.DrawHelpers(i),h.DrawHelperText("Scale: "+c.scale),a.publish("/PivotViewer/Views/Canvas/Zoom",[{x:m,y:n,scale:c.scale}]);return}var o=a(this).offset(),p=c.touches[0].pageX-o.left,q=c.touches[0].pageY-o.top;l={x:p-k.x,y:q-k.y},k={x:p,y:q},a.publish("/PivotViewer/Views/Canvas/Drag",[l])}catch(r){Debug.Log(r.message)}}),b.on("touchend",function(b){var c=b.originalEvent;if(c.touches.length==1&&k==null){var d=a(this).offset(),e=c.touches[0].pageX-d.left,f=c.touches[0].pageY-d.top;(!l||l.x==0&&l.y==0)&&a.publish("/PivotViewer/Views/Canvas/Click",[{x:e,y:f}])}k=null,l=!1;return})},FacetItemClick=function(b){a(b).attr("checked")=="checked"&&a(b.parentElement.parentElement.parentElement).prev().find(".pv-filterpanel-accordion-heading-clear").css("visibility","visible"),FilterCollection()},a.fn.PivotViewer=function(b){if(q[b])return q[b].apply(this,Array.prototype.slice.call(arguments,1));if(typeof b=="object"||!b)return q.init.apply(this,arguments);a.error("Method "+b+" does not exist on jQuery.PivotViewer")}}(jQuery);